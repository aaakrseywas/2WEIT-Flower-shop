<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üå∫ 2WEIT flower | –ö–æ—Ä–∑–∏–Ω–∞</title>
    <link rel="stylesheet" href="/static/order.css">
    <link rel="stylesheet" href="/static/header.css">
    <link rel="stylesheet" href="/static/footer.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Carlito:ital,wght@0,400;0,700;1,400;1,700&family=Overpass+Mono:wght@300..700&display=swap" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">

<body>
    {% include "header.html" %}
 <main>
    <div class="cart-container">
        <h1 class="cart-title">–ö–û–†–ó–ò–ù–ê</h1>
        <div class="cart-content">
            <h3 class="cart-subtitle">–í–∞—à–∏ –∑–∞–∫–∞–∑—ã:</h3>
            {% if cart %}
                <ul class="cart-items">
                    {% for item in cart %}
                        <li class="cart-item">
                            <span class="item-name">{{ item.name }}</span>
                            <span class="item-details">{{ item.sort }} {{ item.color }}</span>
                            <span class="item-quantity"> {{ item.quantity }}</span>
                            <span class="item-price">{{ item.price }} —Ä—É–±.</span>
                        </li>
                    {% endfor %}
                </ul>
                <div class="cart-total">
                    <p>–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞: <span id="totalPrice">{{ total_price }}</span> —Ä—É–±.</p>
                    <p id="discountInfo" style="display: none;">
                        –°–∫–∏–¥–∫–∞: <span id="discountAmount">0</span> —Ä—É–±.
                        –ò—Ç–æ–≥–æ —Å–æ —Å–∫–∏–¥–∫–æ–π: <span id="finalAmount">{{ total_price }}</span> —Ä—É–±.
                    </p>
                </div>
            {% else %}
                <div class="empty-cart">
                    <p>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>
                    <a href="/2weit/menu" class="continue-shopping-btn">–í—ã–±—Ä–∞—Ç—å —Ü–≤–µ—Ç—ã</a>
                </div>
            {% endif %}

            {% if cart %}
                <div class="cart-actions">
                    <a href="/2weit/menu" class="add-more-btn">–î–æ–±–∞–≤–∏—Ç—å –µ—â–µ —Ü–≤–µ—Ç—ã</a>
                    <button id="openDiscountModalBtn" class="apply-discount-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É</button>

                    <!-- –§–æ—Ä–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ -->
                    <form class="checkout-form" action="/2weit/order" method="post">
                        <h4>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h4>
                                <input type="hidden" id="finalPriceInput" name="final_price" value="{{ total_price }}">
                                <input type="hidden" id="discountIdInput" name="discount_id" value="">
                                <input type="hidden" id="discountPercentInput" name="discount_percent" value="0">
                        <div class="form-group">
                            <input type="text" name="name" placeholder="–í–∞—à–µ –∏–º—è" required>
                        </div>
                        <div class="form-group">
                            <input type="text" name="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                        </div>
                        <div class="form-group">
                            <input type="text" name="address" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" required>
                        </div>
                        <div class="form-group">
                            <input type="email" name="email" placeholder="Email" required>
                        </div>
                        <div class="form-group">
                            <select name="payment_method" required>
                                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</option>
                                <option value="card">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
                                <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</option>
                            </select>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="checkout-btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
                            <button type="submit" formaction="/2weit/order/clear_cart" class="clear-cart-btn">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
                        </div>
                    </form>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–∫–∏–¥–∫–∏ -->
    <div id="discountModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É</h3>
            <div class="form-group">
                <input type="text" id="userNameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="hidden" id="userNameHiddenInput" name="user_name">
            </div>
            <button id="applyDiscountBtn" class="apply-discount-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <div id="discountMessage" class="discount-message"></div>
        </div>
    </div>
</main>
    {% include "footer.html" %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–∫–∏–¥–∫–∏
    const modal = document.getElementById('discountModal');
    const openBtn = document.getElementById('openDiscountModalBtn');
    const closeBtn = document.querySelector('.close-modal');
    const applyBtn = document.getElementById('applyDiscountBtn');
    const userNameInput = document.getElementById('userNameInput'); // –ò–∑–º–µ–Ω–µ–Ω–æ —Å discountCode
    const discountMessage = document.getElementById('discountMessage');

    // –≠–ª–µ–º–µ–Ω—Ç—ã –∫–æ—Ä–∑–∏–Ω—ã
    const totalPriceElement = document.getElementById('totalPrice');
    const discountInfoElement = document.getElementById('discountInfo');
    const discountAmountElement = document.getElementById('discountAmount');
    const finalAmountElement = document.getElementById('finalAmount');
    const finalPriceInput = document.getElementById('finalPriceInput');
    const userNameHiddenInput = document.getElementById('userNameHiddenInput'); // –ò–∑–º–µ–Ω–µ–Ω–æ —Å discountIdInput
    const discountPercentInput = document.getElementById('discountPercentInput');

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    if (openBtn && modal) {
        openBtn.addEventListener('click', function() {
            modal.style.display = 'block';
            if (userNameInput) userNameInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
            if (discountMessage) discountMessage.textContent = '';
        });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    if (closeBtn && modal) {
        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–∫–Ω–∞
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏
    if (applyBtn && userNameInput && totalPriceElement) {
        applyBtn.addEventListener('click', function() {
            const userName = userNameInput.value.trim();
            const originalAmount = parseFloat(totalPriceElement.textContent);

            if (!userName) {
                if (discountMessage) {
                    discountMessage.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                    discountMessage.style.color = 'red';
                }
                return;
            }

            fetch('/apply_discount', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_name: userName, // –ò–∑–º–µ–Ω–µ–Ω–æ —Å discount_id
                    original_amount: originalAmount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!discountMessage) return;

                if (data.error) {
                    discountMessage.textContent = data.error;
                    discountMessage.style.color = 'red';
                    return;
                }

                if (data.status === 'invalid' || data.status === 'no_discount') {
                    discountMessage.textContent = data.message || '–°–∫–∏–¥–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                    discountMessage.style.color = 'orange';
                    return;
                }

                // –£—Å–ø–µ—à–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏
                discountMessage.textContent = data.message || '–°–∫–∏–¥–∫–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞';
                discountMessage.style.color = 'green';

                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                if (finalPriceInput) finalPriceInput.value = data.final_amount;
                if (discountPercentInput) discountPercentInput.value = data.discount_percent;
                if (userNameHiddenInput) userNameHiddenInput.value = data.user_name; // –ò–∑–º–µ–Ω–µ–Ω–æ —Å discount_id
                if (discountAmountElement) discountAmountElement.textContent = data.discount_amount.toFixed(2);
                if (finalAmountElement) finalAmountElement.textContent = data.final_amount.toFixed(2);
                if (discountInfoElement) discountInfoElement.style.display = 'block';

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    if (modal) modal.style.display = 'none';
                }, 2000);
            })
            .catch(error => {
                if (discountMessage) {
                    discountMessage.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Å–∫–∏–¥–∫–∏';
                    discountMessage.style.color = 'red';
                }
                console.error('Error:', error);
            });
        });
    }
});
</script>
</body>
</html>